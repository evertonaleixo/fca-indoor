<html>
    <head>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mapwize@4.0.1/mapwize.js"></script>
        <style>
            #mapwize {
                position: relative;
                height: 100%; 
                padding-left: 0px !important;
            }
            #rightmenu {
                position: relative;
                height: 100%;
                
            }
            .my-custom-marker {
                background-color: #69b900;
                font-size: larger;
                color: white;
                padding: 8px;
                font-weight: bolder;
            }

            .dot {
                height: 25px;
                width: 25px;
                border-radius: 50%;
                display: inline-block;
                padding-bottom: 26px;
            }
            .btn-print {
                width: 90%;
                border-radius: 4rem !important;
                background-color: #793eff !important;
                border-color: #793eff !important;
            }
        </style>

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="container-fluid">
          <div class="row h-100" >
            <div id="mapwize" class="col-12"></div>
            
          </div>
        </div>  

        <script>
            this.places_to_visit = [];
            this.static_routes = {
                'brasil': {
                    'id': 'brasil',
                    'type': 'line',
                        'source': {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [{
                                'type':'Feature', 
                                'properties': {'color': '#000000'}, 
                                'geometry': {
                                    'type':'LineString', 
                                    'coordinates': [
                                        [-35.154051, -5.862964],
                                        [-35.154008, -5.863241],
                                        [-35.150864, -5.863230],
                                        [-35.150875, -5.867788],
                                        [-35.152012, -5.867777],
                                        [-35.152023, -5.867585],
                                        [-35.152667, -5.867596],
                                        [-35.152747, -5.867681],
                                        [-35.154946, -5.867668],
                                        [-35.154954, -5.868092],
                                        [-35.156845, -5.868124],
                                        [-35.156849, -5.863085],
                                        [-35.155880, -5.863086],
                                        [-35.155862, -5.863202],
                                        [-35.154032, -5.863196],
                                        [-35.154051, -5.862964]
                                    ]
                                } 
                            }]
                        }
                    },
                    'paint': {
                        'line-width': 4,
                        "line-opacity": 0.5,
                        'line-dasharray': [1, 1],
                        'line-color': ['get', 'color']
                    }
                },
                'europa': {
                    'id': 'europa',
                    'type': 'line',
                        'source': {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [{
                                'type':'Feature', 
                                'properties': {'color': '#000000'}, 
                                'geometry': {
                                    'type':'LineString', 
                                    'coordinates': [
                                        [-35.154051, -5.862964],
                                        [-35.154008, -5.863241],
                                        
                                        [-35.150869, -5.863230],
                                        [-35.150869, -5.865813],
                                        [-35.151119, -5.865813],
                                        [-35.151119, -5.867022],
                                        [-35.154938, -5.867022],
                                        [-35.154938, -5.868089],
                                        [-35.155453, -5.868089],
                                        [-35.155453, -5.863196],
                                        
                                        [-35.154032, -5.863196],
                                        [-35.154051, -5.862964]
                                    ]
                                } 
                            }]
                        }
                    },
                    'paint': {
                        'line-width': 4,
                        "line-opacity": 0.5,
                        'line-dasharray': [1, 1],
                        'line-color': ['get', 'color']
                    }
                },
                'asia': {
                    'id': 'asia',
                    'type': 'line',
                        'source': {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [{
                                'type':'Feature', 
                                'properties': {'color': '#000000'}, 
                                'geometry': {
                                    'type':'LineString', 
                                    'coordinates': [
                                        [-35.154051, -5.862964],
                                        [-35.154008, -5.863241],
                                        
                                        [-35.153455, -5.863230],
                                        [-35.153455, -5.865813],
                                        [-35.151969, -5.865813],
                                        [-35.151969, -5.866510],
                                        [-35.154944, -5.866510],
                                        [-35.154944, -5.868081],
                                        [-35.156848, -5.868081],
                                        [-35.156848, -5.863097],
                                        [-35.155907, -5.863097],
                                        [-35.155861, -5.863193],
                                        [-35.155861, -5.867808],
                                        [-35.155453, -5.867808],
                                        [-35.155453, -5.863193],

                                        [-35.154032, -5.863196],
                                        [-35.154051, -5.862964]
                                    ]
                                } 
                            }]
                        }
                    },
                    'paint': {
                        'line-width': 4,
                        "line-opacity": 0.5,
                        'line-dasharray': [1, 1],
                        'line-color': ['get', 'color']
                    }
                },
                'oceania': {
                    'id': 'oceania',
                    'type': 'line',
                        'source': {
                        'type': 'geojson',
                        'data': {
                            'type': 'FeatureCollection',
                            'features': [{
                                'type':'Feature', 
                                'properties': {'color': '#000000'}, 
                                'geometry': {
                                    'type':'LineString', 
                                    'coordinates': [
                                        [-35.154051, -5.862964],
                                        [-35.154008, -5.863241],
                                        
                                        [-35.151604, -5.863241],
                                        [-35.151604, -5.863861],
                                        [-35.151643, -5.864039],
                                        [-35.151643, -5.865797],
                                        [-35.151956, -5.865797],
                                        [-35.151956, -5.865973],
                                        [-35.154951, -5.865973],
                                        [-35.154951, -5.866508],
                                        [-35.155450, -5.866508],
                                        [-35.155450, -5.863206],
                                        [-35.154948, -5.863206],
                                        [-35.154948, -5.866492],
                                        [-35.155465, -5.866492],
                                        [-35.155465, -5.863186],

                                        [-35.154032, -5.863196],
                                        [-35.154051, -5.862964]
                                    ]
                                } 
                            }]
                        }
                    },
                    'paint': {
                        'line-width': 4,
                        "line-opacity": 0.5,
                        'line-dasharray': [1, 1],
                        'line-color': ['get', 'color']
                    }
                }
            }
            this.routes_name = ['asia', 'europa', 'oceania', 'brasil'];
            this.routes_dist = {'europa': 5000, 'asia': 6000, 'oceania':5500, 'brasil':4000};
            this.id_map_to_static_route = {
                '5de95557e15b1d0016ae0f21': 'europa',
                '5de955854f7a350016fbbb90': 'europa',
                '5de955adccc10f001655d3ac': 'europa',
                '5de955f5cbed9b00161b4671': 'europa',
                '5de95617ccada8001682ef19': 'europa',
                '5de956394f7a350016fbbb92': 'europa',
                '5de9566dccc10f001655d3ae': 'oceania',
                '5de956aeccada8001682ef1b': 'asia',
                '5de95855742fae00169f78cb': 'asia',
                '5de958d3e15b1d0016ae0f24': 'oceania',
                '5de959649baff70016199f50': 'asia',
                '5de95994cbed9b00161b4674': 'asia',
                '5de959d4cbed9b00161b4678': 'asia',
                '5de959f44f7a350016fbbb94': 'brasil',
                '5de95a4b9baff70016199f53': 'asia',
                '5de95a7e4f7a350016fbbb96': 'brasil',
                '5de95ab1ccada8001682ef1e': 'brasil',
                '5de95b0e9baff70016199f55': 'brasil',
                '5de95bb6e15b1d0016ae0f2b': 'brasil',
                '5de95f3ccbed9b00161b4683': 'oceania',
                '5de95fac9baff70016199f5f': 'europa',
                '5de966e6ccada8001682ef26': 'asia',
                '5de96728cbed9b00161b4688': 'oceania',
                '5de9676accc10f001655d3bb': 'oceania',
            }
            thiz = this;
            thiz.click = 0
            

            origin = '5de90d87938b5d00162df274';
            plot_route = (map, point_clicked) => {
                id = point_clicked;

                not_there = (thiz.places_to_visit.filter(v => v.placeId===id).length === 0);
                
                thiz.routes_name.forEach(name => {if(map.getSource(name)!==undefined) {map.removeLayer(name); map.removeSource(name);}});
                map.removeMarkers();

                if (point_clicked!=="") {
                    new_color = '#8b72a2';
                    if(not_there) {
                        thiz.places_to_visit.push({placeId: id});
                        new_color = '#793eff';
                    } else {
                        thiz.places_to_visit = thiz.places_to_visit.filter(v => v.placeId!==id);
                    }
                
                    place_style = {
                        fillColor: new_color
                    };
                    map.setPlaceStyle(id, place_style);
                }
                console.log('000',thiz.places_to_visit)

                static_route_to_plot = new Set();
                thiz.places_to_visit.forEach(place => static_route_to_plot.add(thiz.id_map_to_static_route[place.placeId]));
                
                if (static_route_to_plot.size > 1) {
                    $('#distance_static').text('');
                    $('#name_static').text('Impossível!')
                    $('#static_message').text('Não é possével passar por todos esses gravitacionais com apenas uma rota estática. São necessárias '+static_route_to_plot.size+'.');
                } else if (static_route_to_plot.size === 1) {
                    route_name = static_route_to_plot.entries().next().value[0];
                    $('#distance_static').text(thiz.routes_dist[route_name].toFixed(2));
                    $('#name_static').text(route_name);
                    // map.addLayer(thiz.static_routes[route_name]);
                } else if (static_route_to_plot.size === 0) {
                    dis = 0;
                    $('#distance_static').text(dis.toFixed(2));
                    $('#name_static').text('');
                    $('#static_message').html('Voce percorrerá um total de: <i id="distance_static"> 0.00</i> metros!');
                }


                Mapwize.Api.getDirection({
                    from: {placeId: origin},
                    to: {placeId: origin},
                    waypoints:thiz.places_to_visit,
                    options: {waypointOptimize: true}

                }).then(direction => {
                    // map.setDirection(direction, {centerOnStart: false});
                    // map.setPaintProperty('mapwize_layer_direction_line', 'line-dasharray' , [10,10])

                    thiz.direction = direction;
                    $('#distance').text(direction.distance.toFixed(2))
                    map.removeLayer('lines'+thiz.click);
                    thiz.click = thiz.click + 1;
                    features = direction.route.map(coords => ({
                        'type':'Feature', 
                        'properties': {'color': '#69b900'}, 
                        'geometry': {'type':'LineString', 'coordinates': coords.path.map(path => [path[1], path[0]])} 
                        })
                    );
                    features[features.length-1].properties.color = '#F7455D'

                    layer_ = {
                        'id': 'lines'+thiz.click,
                        'type': 'line',
                            'source': {
                            'type': 'geojson',
                            'data': {
                                'type': 'FeatureCollection',
                                'features': features
                            }
                        },
                        'paint': {
                            'line-width': 4,
                            "line-opacity": 0.5,
                            'line-dasharray': [1, 1],
                            'line-color': ['get', 'color']
                        }
                    }
                    thiz.layer_ = layer_
                    map.addLayer(layer_);

                    direction.waypoints.forEach((element, idx) => {
                        el = document.createElement('div');
                        el.innerHTML += ''+(idx+1);
                        el.className = 'marker my-custom-marker dot';
                        

                        myCustomMarker = new Mapwize.Marker(el);

                        map.addMarker(element, myCustomMarker).then(marker => {
                            // Marker as been added on map
                            
                        }).catch(err => {
                            return  console.error('addMarker failed', err);
                        });
                    });

                });
            }

            reset = (e) => {
                var dis = 0;
                $('#distance').text(dis.toFixed(2));
                $('#distance_static').text(dis.toFixed(2));
                $('#name_static').text('');
                $('#static_message').html('Voce percorrerá um total de: <i id="distance_static"> 0.00</i> metros!');

                thiz.places_to_visit.forEach(place => {
                    place_style = {
                        fillColor: '#8b72a2'
                    };
                    map.setPlaceStyle(place.placeId, place_style);
                });
                thiz.places_to_visit = [];
                plot_route(thiz.map, '')
            };

            Mapwize.apiKey('c0ad29d0a22c4ff1db799ea4a363f1f0')
            Mapwize.map({
                container: 'mapwize',
                mainColor: '#69b900',
                maxBounds: [ [-35.162580, -5.871139], [
                -35.140436, -5.858865] ],
                center: [-35.151443, -5.865717],
	            minZoom:  11,
            }).then(map => {
                // map.centerOnVenue('5ddd4db73b768a00169c81c9');
                thiz.map = map;
                reset();
                
                map.on('mapwize:click', e => {
                    if (e.place != null) {
                        console.log(e.place)
                        id = e.place._id;

                        if (id===origin) return;
                        
                        plot_route(map, id);
                    }
                });

            }).catch(err => {
                console.error(err);
            });

        </script>

        
    </body>
</html>
